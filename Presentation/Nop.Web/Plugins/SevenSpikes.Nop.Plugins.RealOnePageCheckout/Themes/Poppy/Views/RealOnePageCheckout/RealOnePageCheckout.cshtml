@model RealOnePageCheckoutModel

@inject IWebHelper webHelper;
@inject RealOnePageCheckoutSettings onePageCheckoutSettings;

@{
    Layout = "~/Views/Shared/_ColumnsOne.cshtml";
    Html.AppendPageCssClassParts("html-real-opc-page");

    //title
    Html.AddTitleParts(T("PageTitle.Checkout").Text);

    var storeLocation = webHelper.GetStoreLocation();
    var themeName = ThemeHelper.GetPluginTheme(Plugin.FolderName);
}

@if (Model.TotalProducts > 0 && !Model.ShowNoShippingMethodsMessage)
{
    Html.AddScriptParts("~/Plugins/SevenSpikes.Core/Scripts/sevenspikes.core.min.js");
    Html.AddScriptParts("~/Plugins/SevenSpikes.Core/Scripts/jquery.livequery.min.js");

    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/ie8-fixes.min.js");
    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/angular/angular.min.js");

    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/app.min.js");

    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/shared/address.service.min.js");
    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/shared/api.service.min.js");
    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/shared/data.service.min.js");
    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/shared/stateHolder.service.min.js");

    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/utils/object.utility.min.js");
    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/utils/namedQueue.utility.min.js");
    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/utils/nativeEvents.utility.min.js");

    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/filters/countrySubjectToVat.filter.min.js");
    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/filters/prepareName.filter.min.js");
    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/filters/textPrompt.filter.min.js");
    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/filters/priceAdjustment.filter.min.js");
    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/filters/prepareEditUrl.filter.min.js");

    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/billingAddress/billingAddress.controller.min.js");
    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/billingAddress/billingAddress.context.min.js");
    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/billingAddress/billingAddress.service.min.js");

    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/shippingAddress/shippingAddress.controller.min.js");
    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/shippingAddress/shippingAddress.context.min.js");
    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/shippingAddress/shippingAddress.service.min.js");

    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/paymentMethods/paymentMethods.controller.min.js");
    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/paymentMethods/paymentMethods.context.min.js");
    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/paymentMethods/paymentMethods.service.min.js");

    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/shippingMethods/shippingMethods.controller.min.js");
    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/shippingMethods/shippingMethods.context.min.js");
    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/shippingMethods/shippingMethods.service.min.js");

    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/orderSummary/orderSummary.controller.min.js");
    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/orderSummary/orderSummary.context.min.js");
    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/orderSummary/orderSummary.service.min.js");

    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/orderTotal/orderTotal.controller.min.js");
    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/orderTotal/orderTotal.context.min.js");
    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/orderTotal/orderTotal.service.min.js");

    if (onePageCheckoutSettings.ShowDiscountBox)
    {
        Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/discountBox/discountBox.controller.min.js");
        Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/discountBox/discountBox.context.min.js");
        Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/discountBox/discountBox.service.min.js");
    }

    if (onePageCheckoutSettings.ShowGiftCardBox)
    {
        Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/giftCardBox/giftCardBox.controller.min.js");
        Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/giftCardBox/giftCardBox.context.min.js");
        Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/giftCardBox/giftCardBox.service.min.js");
    }

    if (onePageCheckoutSettings.ShowEstimateShipping)
    {
        Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/estimateShipping/estimateShipping.controller.min.js");
        Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/estimateShipping/estimateShipping.context.min.js");
        Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/estimateShipping/estimateShipping.service.min.js");
    }

    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/checkoutAttributes/checkoutAttributes.controller.min.js");
    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/checkoutAttributes/checkoutAttributes.context.min.js");
    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/checkoutAttributes/checkoutAttributes.service.min.js");

    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/orderConfirm/orderConfirm.controller.min.js");
    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/orderConfirm/orderConfirm.context.min.js");
    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/orderConfirm/orderConfirm.service.min.js");

    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/pickupInStore/pickupInStore.controller.min.js");
    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/pickupInStore/pickupInStore.context.min.js");
    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/pickupInStore/pickupInStore.service.min.js");

    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/dispatchers/data.dispatcher.min.js");

    Html.AddScriptParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Scripts/app/external/external.controller.min.js");

    var supportRtl = this.ShouldUseRtlTheme();

    Html.AddCssFileParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Styles/RealOnePageCheckout.common.css");

    if (supportRtl)
    {
        Html.AddCssFileParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Styles/RealOnePageCheckout.common.rtl.css");
    }

    Html.AddCssFileParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Themes/" + themeName + "/Content/RealOnePageCheckout.css");

    if (supportRtl)
    {
        Html.AddCssFileParts("~/Plugins/SevenSpikes.Nop.Plugins.RealOnePageCheckout/Themes/" + themeName + "/Content/RealOnePageCheckout.rtl.css");
    }

    @Html.Hidden("storeLocation", storeLocation)
    @Html.Hidden("flyoutShoppingCartUrlROPC", Url.RouteUrl("NopOPCFlyoutCart"))
    @Html.Hidden("flyoutShoppingCartPanelSelectorROPC", Html.Encode(onePageCheckoutSettings.FlyoutCartPanelSelector))
    @Html.Hidden("shoppingCartMenuLinkSelectorROPC", Html.Encode(onePageCheckoutSettings.ShoppingCartMenuLinkSelector))

    <script type="text/javascript">
        $(document).ready(function () {
            function getWindowProportions() {
                var e = window, a = 'inner';
                if (!('innerWidth' in window)) {
                    a = 'client';
                    e = document.documentElement || document.body;
                }

                var result = { width: e[a + 'Width'], height: e[a + 'Height'] };

                return result;
            }

            function scrollToElement(elementToScroll) {

                $('html, body').animate({
                    scrollTop: $(elementToScroll).offset().top
                }, 0);
            }

            $('.page-body').on('click', '.ropc .section-title', function () {
                var result = getWindowProportions();

                if (result.width < 769) {
                    $(this).siblings('.section-body').slideToggle('slow');
                }
            });

            $(document).on('orderConfirmError', function () {
                var result = getWindowProportions();

                if (result.width < 769) {
                    var billingAddress = '.billing-address .section-title.title';
                    var shippingAddress = '.shipping-address .section-title.title';

                    var doesBillingFormHaveErrors = $('.billing-address .inputs input.has-error').length > 0;
                    var doesShippingFormHaveErrors = $('.shipping-address .inputs input.has-error').length > 0;

                    if (doesBillingFormHaveErrors) {
                        $(billingAddress).siblings('.section-body').slideDown('fast');

                        scrollToElement(billingAddress);
                    }

                    if (doesShippingFormHaveErrors) {
                        $(shippingAddress).siblings('.section-body').slideDown('fast');

                        if (!doesBillingFormHaveErrors) {
                            scrollToElement(shippingAddress);
                        }
                    }
                }
            });
        });
    </script>
}

<div class="page checkout-page ropc-page" ng-app="realOnePageCheckout">
    <div class="page-title">
        <h1>@T("SevenSpikes.RealOnePageCheckout.Public.CheckoutTitle")</h1>
    </div>
    <div class="page-body">
        <div class="ropc">
            @if (Model.TotalProducts > 0 && !Model.ShowNoShippingMethodsMessage)
            {
                <form id="checkoutForm" name="checkoutForm" ng-controller="OrderConfirmController as vm" valid-submit="vm.validateForm(checkoutForm)" novalidate>
                    
                    @Html.AntiForgeryToken()

                    @await Html.PartialAsync("_AjaxLoader", "confirm-order-loader")

                    <div class="panel-group panel-group-left">
                        <div class="panel billing-address-panel">
                            @await Html.PartialAsync("BillingAddress")
                        </div>
                        <div class="panel shipping-address-panel">
                            @await Html.PartialAsync("ShippingAddress")
                        </div>

                        @if (onePageCheckoutSettings.ShowEstimateShipping)
                        {
                            <div class="panel estimate-shipping-panel">
                                @await Html.PartialAsync("EstimateShipping")
                            </div>
                        }
                    </div>

                    <div class="panel-group panel-group-right-top">
                        <div class="panel shipping-method-panel">
                            @await Html.PartialAsync("ShippingMethod")
                        </div>
                        <div class="panel payment-method-panel">
                            @await Html.PartialAsync("PaymentMethod")
                        </div>
                    </div>

                    <div class="panel-group panel-group-right-middle">
                        <div class="panel order-summary-panel">
                            @await Html.PartialAsync("OrderSummary")
                        </div>
                    </div>

                    <div class="panel-group panel-group-right-bottom">
                        @if (onePageCheckoutSettings.ShowDiscountBox)
                        {
                            <div class="panel coupon-box-panel">
                                @await Html.PartialAsync("DiscountBox")
                            </div>
                        }

                        @if (onePageCheckoutSettings.ShowGiftCardBox)
                        {
                            <div class="panel giftcard-box-panel">
                                @await Html.PartialAsync("GiftCardBox")
                            </div>
                        }

                        <div class="panel attributes-panel">
                            @await Html.PartialAsync("CheckoutAttributes")
                        </div>
                        <div class="totals">
                            <div class="panel order-totals-panel">
                                @await Html.PartialAsync("OrderTotals")
                            </div>

                            <div class="panel complete-order-panel">
                                <div class="order-confirm" ng-show="vm.orderConfirmData.errors.length > 0">
                                    <ul class="error-list">
                                        <li class="error-item" ng-repeat="error in vm.orderConfirmData.errors track by $index">
                                            <span class="error-text">{{error}}</span>
                                        </li>
                                    </ul>
                                </div>
                                <div class="terms-of-service" ng-show="vm.config.termsOfServiceOnOrderConfirmPage">
                                    <input type="checkbox" id="terms-of-service" name="termsOfService" ng-model="termsOfService" ng-required="vm.config.termsOfServiceOnOrderConfirmPage"/>
                                    <label for="terms-of-service">@T("Checkout.TermsOfService.IAccept")<a class="read" onclick="javascript:OpenWindow('@Url.RouteUrl("TopicPopup", new {SystemName = "conditionsofuse"})', 450, 500, true)">@T("Checkout.TermsOfService.Read")</a></label>
                                </div>

                                <div class="buttons complete-button">
                                    <button class="button-1 checkout-button" type="submit" data-processing="@T("SevenSpikes.RealOnePageCheckout.Public.ProcessingButton")" data-complete="@T("SevenSpikes.RealOnePageCheckout.Public.CompleteButton")">@T("SevenSpikes.RealOnePageCheckout.Public.CompleteButton")</button>
                                </div>
                                <div class="addon-buttons">
                                    @*Payment method buttons (e.g. GoogleCheckoutButton, Paypal Express)*@

                                    @foreach (var viewComponentName in Model.ButtonPaymentMethodViewComponentNames)
                                    {
                                        @await Component.InvokeAsync(viewComponentName)
                                    }
                                </div>
                            </div>
                        </div>

                        @*<div class="cross-sells">
                            @Html.Action("CrossSellProducts", "Product")
                        </div>*@
                    </div>
                </form>
            }
            else if (Model.ShowNoShippingMethodsMessage)
            {
                <span>@T("SevenSpikes.RealOnePageCheckout.Public.NoShippingProvidersError")</span>
            }
            else
            {
                <span>@T("SevenSpikes.RealOnePageCheckout.Public.EmptyShoppingCart")</span>
            }
        </div>
    </div>

    <div ng-controller="ExternalController as vm" ng-hide="true"></div>
</div>

<span style="display: none" id="invalidFormMessage">@T("SevenSpikes.RealOnePageCheckout.Public.InvalidForm")</span>
<span style="display: none" id="invalidFormMessageForTermsOfService">@T("SevenSpikes.RealOnePageCheckout.Public.TermsOfServiceNotChecked")</span>
